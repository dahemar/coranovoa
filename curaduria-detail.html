<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cora Novoa - Curaduría - <span id="detail-title">Detalle</span></title>
    
    <!-- Preload fonts -->
    <link rel="preload" href="junicode.webfont/junicode_regular.woff" as="font" type="font/woff" crossorigin="anonymous">
    <link rel="preload" href="junicode.webfont/junicode_bold.woff" as="font" type="font/woff" crossorigin="anonymous">
    <link rel="preload" href="fonts/demo-atbserif-it.otf" as="font" type="font/opentype" crossorigin="anonymous">
    
    <!-- Add accent.css -->
    <link rel="stylesheet" href="accent.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="navigation.css">
    <style>
        /* Font Definitions */
        @font-face {
            font-family: 'Junicode';
            src: url('junicode.webfont/junicode_regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'Junicode';
            src: url('junicode.webfont/junicode_bold.woff') format('woff');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'ATB Serif';
            src: url('fonts/demo-atbserif-it.otf') format('opentype');
            font-weight: normal;
            font-style: italic;
            font-display: swap;
        }
        
        body {
            font-family: 'Junicode', sans-serif;
            margin: 0;
            background-color: white;
            color: black;
            overflow-y: scroll;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Junicode', sans-serif;
            font-weight: bold;
        }

        .overlay-content {
            position: relative;
            z-index: 10;
            padding: 40px 0 40px 160px;
            max-width: 1600px;
            margin: 0 auto;
            transition: transform 0.5s ease-out;
            width: 100%;
        }

        .detail-container {
            position: relative;
            margin-top: 135px;
            min-height: 500px;
            max-width: 1200px;
        }

        .detail-content {
            margin-top: 120px;
            display: flex;
            gap: 40px;
        }

        .detail-image {
            width: 400px;
            height: 300px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .detail-text {
            flex: 1;
            font-size: 15px;
            line-height: 1.6;
            color: #333;
        }

        .detail-title {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .detail-title .atb-title {
            font-family: 'ATB Serif', serif;
            font-weight: normal;
            font-style: italic;
        }
        
        /* Asegurar que los acentos se apliquen correctamente en elementos dinámicos */
        .atb-title .atb-a-accent,
        .atb-title .atb-i-accent,
        .atb-title .atb-o-accent,
        .atb-title .atb-u-accent,
        .atb-title .atb-e-accent {
            font-family: inherit;
            display: inline-block;
            position: relative;
        }
        
        .atb-title .atb-a-accent .base,
        .atb-title .atb-i-accent .base,
        .atb-title .atb-o-accent .base,
        .atb-title .atb-u-accent .base,
        .atb-title .atb-e-accent .base {
            font-family: 'ATB Serif', serif;
            font-weight: normal;
            font-style: italic;
        }
        
        .atb-title .atb-a-accent .accent,
        .atb-title .atb-i-accent .accent,
        .atb-title .atb-o-accent .accent,
        .atb-title .atb-u-accent .accent,
        .atb-title .atb-e-accent .accent {
            position: absolute;
            left: 50%;
            top: 0em;
            transform: translateX(-50%);
            font-family: 'Junicode', serif;
            font-size: 0.9em;
        }

        /* Hide back button on desktop */
        .back-button {
            display: none;
        }



        /* Mobile responsive styles */
        @media (max-width: 768px) {
            body {
                overflow: hidden;
                position: fixed;
                width: 100%;
                height: 100%;
            }
            
            .overlay-content {
                padding: 20px;
                position: fixed;
                width: 100%;
                height: 100%;
                overflow-y: auto;
                background-color: white;
                z-index: 1000;
            }

            /* Hide header on mobile */
            .overlay-header {
                display: none;
            }

            .detail-container {
                margin-top: 0;
                padding: 0;
            }

            .detail-content {
                margin-top: 0;
                flex-direction: column;
                gap: 30px;
            }

            .detail-image {
                width: 100%;
                height: auto;
                object-fit: contain;
                max-height: 45vh;
                background-color: #f0f0f0;
                margin-bottom: 10px;
            }

            .detail-title {
                font-size: 16px;
                margin-bottom: 25px;
                line-height: 1.4;
            }

            .detail-text {
                color: #a0a0a0;
                font-size: 15px;
                line-height: 1.6;
                margin-top: 10px;
            }

            .back-button {
                display: inline-block;
                margin-top: 45px;
                margin-bottom: -5px;
                padding-left: 20px;
                color: black;
                text-decoration: none;
                font-size: 16px;
                font-weight: normal;
            }
        }

        @media (max-width: 480px) {
            .detail-text {
                font-size: 14px;
            }
            
            .detail-title {
                font-size: 15px;
                margin-bottom: 20px;
            }
            
            .back-button {
                font-size: 15px;
                margin-top: 45px;
                margin-bottom: -5px;
                padding-left: 20px;
            }
            
            .detail-content {
                gap: 25px;
            }
        }
    </style>
</head>

<body>
    <div class="page-container">
        <!-- Back button for mobile -->
        <a href="curaduria.html" class="back-button" onclick="goBack(); return false;">←</a>
        
        <!-- Language switcher -->
        <div class="language-switcher">
            <a href="#" onclick="changeLanguage('gal'); return false;" data-lang="gal">gal</a> /
            <a href="#" onclick="changeLanguage('esp'); return false;" data-lang="esp">esp</a> /
            <a href="#" onclick="changeLanguage('en'); return false;" data-lang="en">en</a>
        </div>
        
        <div class="overlay-content">
            <header class="overlay-header">
                <h1 class="hover-light-grey"><a href="index.html" class="no-underline-link">Cora Novoa</a></h1>
                <nav>
                    <a href="obra.html" class="no-underline-link">obra</a>
                    <a href="bio.html" class="no-underline-link">bio</a>
                    <a href="aldan.html" class="no-underline-link">aldán</a>
                    <a href="curaduria.html" class="no-underline-link active">curaduría</a>
                    <a href="contacto.html" class="no-underline-link">contacto</a>
                </nav>
            </header>

            <div class="detail-container">
                <div class="detail-content">
                    <h2 id="detail-title" class="detail-title"></h2>
                    <img id="detail-image" class="detail-image" src="" alt="">
                    <div class="detail-text">
                        <div id="detail-description"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const projectOrden = urlParams.get('orden');
        const currentLang = urlParams.get('lang') || 'gal';

        // Load project data from Google Sheets
        async function loadProjectData() {
            try {
                // Add timeout to prevent hanging requests
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/1GC8bqmQeQHD0H1QnIGAQbOPtBg19_4dkspwZEUjgi1k/values/Curaduria?key=AIzaSyBHQgbSv588A3qr-Kzeo6YrZ9TbVNlrSkc`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    const headers = data.values[0];
                    const projects = data.values.slice(1)
                        .map((row, index) => {
                            const project = {};
                            headers.forEach((header, headerIndex) => {
                                project[header] = row[headerIndex] || '';
                            });
                            // Usar el índice de la fila como orden automático
                            project.orden = index + 1;
                            return project;
                        });
                    
                    const project = projects.find(p => p.orden == projectOrden);
                    if (project) {
                        displayProject(project);
                    } else {
                        // Clear content and show nothing
                        document.getElementById('detail-title').innerHTML = '';
                        document.getElementById('detail-description').textContent = '';
                        document.getElementById('detail-image').src = '';
                    }
                } else {
                    console.error('No data found in Google Sheets');
                    // Clear content and show nothing
                    document.getElementById('detail-title').innerHTML = '';
                    document.getElementById('detail-description').textContent = '';
                    document.getElementById('detail-image').src = '';
                }
            } catch (error) {
                console.error('Error loading project data:', error);
                // Clear content and show nothing
                document.getElementById('detail-title').innerHTML = '';
                document.getElementById('detail-description').textContent = '';
                document.getElementById('detail-image').src = '';
            }
        }
        
        function processTextWithLineBreaks(text) {
            if (!text) return '';
            return text.replace(/\n/g, '<br>');
        }
        
        function processTextWithAccents(text) {
            if (!text) return '';
            
            // Debug: verificar si hay acentos en el texto
            const hasAccents = /[áéíóúàèìòù]/i.test(text);
            if (hasAccents) {
                console.log('Processing text with accents:', text);
            }
            
            // Aplicar acentos a las letras específicas
            const processed = text
                .replace(/á/g, '<span class="atb-a-accent"><span class="base">a</span><span class="accent">´</span></span>')
                .replace(/í/g, '<span class="atb-i-accent"><span class="base">i</span><span class="accent">´</span></span>')
                .replace(/ó/g, '<span class="atb-o-accent"><span class="base">o</span><span class="accent">´</span></span>')
                .replace(/ú/g, '<span class="atb-u-accent"><span class="base">u</span><span class="accent">´</span></span>')
                .replace(/é/g, '<span class="atb-e-accent"><span class="base">e</span><span class="accent">´</span></span>')
                .replace(/à/g, '<span class="atb-a-accent"><span class="base">a</span><span class="accent">`</span></span>')
                .replace(/ì/g, '<span class="atb-i-accent"><span class="base">i</span><span class="accent">`</span></span>')
                .replace(/ò/g, '<span class="atb-o-accent"><span class="base">o</span><span class="accent">`</span></span>')
                .replace(/ù/g, '<span class="atb-u-accent"><span class="base">u</span><span class="accent">`</span></span>')
                .replace(/è/g, '<span class="atb-e-accent"><span class="base">e</span><span class="accent">`</span></span>');
            
            if (hasAccents && processed !== text) {
                console.log('Accents processed successfully');
            }
            
            return processed;
        }
        
        function extractImageUrl(url) {
            if (!url) return null;
            
            let cleanUrl = url.trim();
            
            // Procesar formato [img]URL[/img] (Imgur y otros)
            const imgTagMatch = cleanUrl.match(/\[img\](.*?)\[\/img\]/i);
            if (imgTagMatch) {
                cleanUrl = imgTagMatch[1].trim();
            }
            
            // Procesar URLs de Imgur
            if (cleanUrl.includes('imgur.com')) {
                // Convertir URLs de Imgur a formato directo
                if (cleanUrl.includes('/a/')) {
                    // Album de Imgur - usar la primera imagen
                    cleanUrl = cleanUrl.replace('/a/', '/').replace('imgur.com', 'i.imgur.com') + '.jpg';
                } else if (cleanUrl.includes('imgur.com/')) {
                    // Imagen individual de Imgur
                    const imgurId = cleanUrl.split('/').pop().split('.')[0];
                    cleanUrl = `https://i.imgur.com/${imgurId}.jpg`;
                }
            }
            
            return cleanUrl;
        }
        
        function displayProject(project) {
            // Validar y obtener el título con fallbacks robustos
            let title = '';
            if (project && project[`titulo_${currentLang}`] && project[`titulo_${currentLang}`].trim()) {
                title = project[`titulo_${currentLang}`].trim();
            } else if (project && project.titulo_esp && project.titulo_esp.trim()) {
                title = project.titulo_esp.trim();
            } else if (project && project.titulo_gal && project.titulo_gal.trim()) {
                title = project.titulo_gal.trim();
            } else if (project && project.titulo_en && project.titulo_en.trim()) {
                title = project.titulo_en.trim();
            } else {
                title = 'Título no disponible';
                console.warn('No valid title found for project:', project);
            }
            
            const description = processTextWithLineBreaks(project[`descripcion_${currentLang}`] || project.descripcion_esp || '');
            const image = extractImageUrl(project.imagen_url || 'images/1.webp');
            const info = project[`info_${currentLang}`] || project.info_esp || '';
            const subtitle = project.subtitle || '';
            
            // Aplicar acentos al título
            const titleWithAccents = processTextWithAccents(title);
            
            // Create title with info and subtitle
            let fullTitle = `<span class="atb-title">${titleWithAccents}</span>`;
            if (subtitle || info) {
                let subtitlePart = subtitle || '';
                let infoPart = info || '';
                let separator = subtitlePart && infoPart ? ', ' : '';
                fullTitle += ` | ${subtitlePart}${separator}${infoPart}`;
            }
            
            document.getElementById('detail-title').innerHTML = fullTitle;
            document.getElementById('detail-description').innerHTML = description;
            document.getElementById('detail-image').src = image;
            document.getElementById('detail-image').alt = title;
            
            // Verificar que los acentos se aplicaron correctamente
            setTimeout(() => {
                const accentElements = document.querySelectorAll('.atb-a-accent, .atb-i-accent, .atb-o-accent, .atb-u-accent, .atb-e-accent');
                console.log(`Found ${accentElements.length} accent elements in detail page`);
                
                accentElements.forEach((el, index) => {
                    const base = el.querySelector('.base');
                    const accent = el.querySelector('.accent');
                    if (base && accent) {
                        console.log(`Detail accent ${index + 1}: ${base.textContent} with accent ${accent.textContent}`);
                    }
                });
            }, 100);
        }

        // Initialize project data
        function initializeProject() {
            if (!projectOrden) {
                window.location.href = 'curaduria.html';
                return;
            }
            loadProjectData();
        }

        // Language switching
        function changeLanguage(lang) {
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('lang', lang);
            window.location.href = newUrl.toString();
        }

        // Update active language indicator
        function updateLanguageIndicator() {
            document.querySelectorAll('.language-switcher a').forEach(link => {
                link.classList.remove('active-lang');
                if (link.getAttribute('data-lang') === currentLang) {
                    link.classList.add('active-lang');
                }
            });
        }

        // Back button functionality with cleanup
        function goBack() {
            // Simple navigation back to curaduria.html
            window.location.href = 'curaduria.html';
        }

        // Handle browser back button with cleanup
        let popstateHandler = function(event) {
            // Only redirect if we're coming from outside the app
            // Let natural navigation work for internal pages
            if (!event.state) {
                // Clean up before redirecting
                cleanupPage();
                window.location.href = 'curaduria.html';
            }
        };
        
        window.addEventListener('popstate', popstateHandler);

        // Handle window resize to redirect to desktop version
        let resizeTimeout;
        let lastWidth = window.innerWidth;
        let isRedirecting = false;
        
        let resizeHandler = function() {
            clearTimeout(resizeTimeout);
            
            const currentWidth = window.innerWidth;
            const wasMobile = lastWidth <= 767;
            const isNowDesktop = currentWidth > 767;
            
            // Only redirect if we're crossing the threshold from mobile to desktop
            if (wasMobile && isNowDesktop && !isRedirecting) {
                isRedirecting = true;
                // Clean up before redirecting
                cleanupPage();
                window.location.href = 'curaduria.html';
                return;
            }
            
            lastWidth = currentWidth;
            
            // Fallback timeout for edge cases
            resizeTimeout = setTimeout(function() {
                if (currentWidth > 767 && !isRedirecting) {
                    isRedirecting = true;
                    cleanupPage();
                    window.location.href = 'curaduria.html';
                }
            }, 100);
        };
        
        window.addEventListener('resize', resizeHandler);
        
        // Cleanup function to prevent memory leaks
        function cleanupPage() {
            // Remove event listeners
            window.removeEventListener('popstate', popstateHandler);
            window.removeEventListener('resize', resizeHandler);
            
            // Clear timeouts
            if (resizeTimeout) {
                clearTimeout(resizeTimeout);
            }
            
            // Clear any pending operations
            if (window.fetch) {
                // Abort any pending fetch requests
                // Note: This is a simplified approach - in a real app you'd track AbortController instances
            }
            
            // Clear DOM references
            const elements = document.querySelectorAll('.atb-a-accent, .atb-i-accent, .atb-o-accent, .atb-u-accent, .atb-e-accent');
            elements.forEach(el => {
                el.removeEventListener('click', null);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeProject();
            updateLanguageIndicator();
            
            // Don't add history entry - let the browser handle navigation naturally
            // This prevents conflicts with the back button
        });
        
        // Clean up when page is about to unload
        window.addEventListener('beforeunload', function() {
            cleanupPage();
        });
        
        // Clean up when page becomes hidden (Safari specific)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is being hidden, clean up resources
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
            }
        });
    </script>
</body>

</html> 